# ANS-666: Wrapped transactions

Status: RFC

## Abstract

This document describes the wrapped transactions format - a format, that allows to bundle already created and signed Arweave
transactions without changing their content, signature, owner, etc.
It is using ANS-104 under the hood.

## Motivation

Wrapping an Arweave transaction in an ANS-104 data item provides multiple benefits:

- Allow delegation of payment for a transaction to a 3rd party

- Allows to maintain the original transaction signature and all of its contents (in particular - its id) in an unchanged form. This is
very important for some protocols - like the SmartWeave smart contracts protocol, which is using the original
transaction id to compute the sort key (which is then used define the order of executing contract's transactions).

- Allows to make the original transactions instantly available via arweave.net/Bundlr cache - which is
very beneficial for the SmartWeave protocol and significantly increases both the UX/DS

## Reference Implementation

add a link to Warp Sequencer?

## Specification

### 1. Transaction Format

Wrapped transactions are created using the standard Bundlr js-sdk (or any other client that allows to create ANS-104 data-items).
Such data-item can be simply considered as a carrier of the originally created transaction.

```ts
const userWallet = /* read user wallet */
const originalTx = await arweave.createTransaction(/* tx data */, userWallet);
originalTx.addTag(/* add required tags, e.g. SmartWeave protocol tags*/);
await arweave.transactions.sign(originalTx, userWallet);

const dataItemTags = /* data-item tags generated according to spec in point 1.1 */
const dataItemTx = bundlr.createTransaction(JSON.stringify(originalTx), {dataItemTags});
await dataItemTx.sign();
const bundlrResponse = await dataItemTx.upload();

const originalTxId = originalTx.getId();
const wrappedTxId = dataItemTx.getId();
```

#### 1.1 Transaction Tags

A data item that wraps the original transaction MUST have the following two tags present:

- `Original-Tx-Id` id of the original tx - as it was created and signed by the client
- `Original-Tx-Owner` wallet address of the original transaction signer

A data item MUST also contain all the tags rewritten from the original transaction.

A data item MAY contain additional tags.

#### 1.2 Transaction Body Format

```
ANS-104 bundle transaction
┌─────────────────────────────────────────────────────┐
│                                                     │
│ ANS-104 Data Item                                   │
│ ┌──────────────────────────────────────────────┐    │
│ │ - id                                         │    │
│ │ - signature                                  │    │
│ │ - tags                                       │    │
│ │ - ...the rest of ANS-104 Data Item fields    │    │
│ │ - data                                       │    │
│ │     │                                        │    │
│ │     │                                        │    │
│ │     │ ┌────────────────────────────────────┐ │    │
│ │     └►│ JSON.stringify(originalTransaction)│ │    │
│ │       └────────────────────────────────────┘ │    │
│ │                                              │    │
│ └──────────────────────────────────────────────┘    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### 1.3 Indexing wrapped transactions

A gateway that wants to implement ANS-666 standard, should additionally store the id of the original transaction
(using the `Original-Tx-Id` tag). The original transaction should be accessible via
1. `/{originalTxId}` endpoint - this endpoint should return the `data` field of the original transaction (similarly to https://arweave.net/tx/P5lD2PtSVw-W5qOanH6vznSY6nEI62MnOOZBXQgzpiw)
2. `/tx/{originalTxId}` endpoint - this endpoint should return the full original transaction object - similarly
to https://arweave.net/tx/P5lD2PtSVw-W5qOanH6vznSY6nEI62MnOOZBXQgzpiw

