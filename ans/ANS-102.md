# ANS-102: Bundled Data Items - JSON Format

Status: Draft

Version: -

## Abstract

This document describes the data format and directions for writing and reading a bundle of DataItems

## Motivation

Bundling multiple logical data transactions (DataItems) into one transaction provides a number of benefits:

1. To allow delegation of payment for a DataItem to a 3rd party, while maintaining the identity and signature of person who created the DataItem, without them needing to have a wallet with funds.

2. Allow multiple DataItems to be written as a group.

3. To increase the throughput of logically independent data writes to the Arweave network

## Specification

### 1. Format

#### 1.1 Transaction Tags

A bundle of DataItems MUST have the following two tags present:

- `Bundle-Format` a string describing the bundling format. The format for this standard is `json`
- `Bundle-Version` a version string. The version referred to in this standard is `1.0.0`

#### 1.2 Transaction Body Format

This format for the transaction body is a JSON object in the following format

```
{
  items: [
    { DataItem },
    { DataItem }
  ]
}
```

### 1.3 DataItem Format

A DataItem is a JSON object that has similar properties to a transaction:

B64U Encoding indicates the field is Base64Url encoded value.

All properties MUST be present, for optional values the value in 'Empty Value' MUST be used.

|Field     |Description                                   | Encoding        | Empty Value      |
|---       |---                                           |---              |---               |
|owner     |The public key of the owner                   | B64U            |                  |
|target    |A wallet that this DataItem is being sent to  | B64U            | Empty String     |
|nonce     |A value to prevent replay attacks             | B64U            | Empty String     |
|tags      |An array of tag objects                       | Json Array      | Empty Json Array |
|data      |The data contents                             | B64U            |                  |
|signature |A signature produced by owner                 | B64U            |                  |
|id        |The id the item                               | B64U            |                  |

A tag object is a JSON object with the following two keys. A tag object MUST NOT have any other keys.

|Field     |Description               | Encoding        | Empty Value      |
|---       |---                       |---              |---               |
|name      |Name of the tag           | B64U            |                  |
|value     |Value of the tag          | B64U            |                  |

The fields in the DataItem and Tags objects can be handled in an identical way as their counterpart in a layer 1 transaction.

The `nonce` field in DataItem is optional, and is an arbitrary value to allow bundling gateways to provide protection from replay attacks against them or their users.

### 2. DataItem signature and id

The signature, and id for a DataItem is built in a manner similar to Arweave 2.0 transaction signing. It uses the Arweave 2.0 deep-hash algorithm to obtain a hash of the contents of the DataItem. The resulting hash is used as a message to be signed by the owner and obtain `signature`. `id` is then the SHA256 hash of this signature.

The 2.0 deep-hash algorithm operates on a type of `type DeepHashChunk = Uint8Array | DeepHashChunk[]`

The exact data and structure passed to the deep hash algorithm is as follows:

```
[
  utf8Encoded("dataitem"),
  utf8Encoded("1"),
  owner,
  target,
  nonce,
  [
    ... [ tagName, tagValue ],
    ... [ tagName, tagValue ],
    ...
  ],
  data
]
```

There a reference implementations for the deep-hash algorithm in [Erlang](https://github.com/ArweaveTeam/arweave/blob/b316173cd42a53a59036241f8e164b615db9b40d/apps/arweave/src/ar_deep_hash.erl) and [TypeScript](https://github.com/ArweaveTeam/arweave-js/blob/b1c4b2e378a1eb7dc1fbfaeee41492eb908a60c6/src/common/lib/deepHash.ts)

There is a reference implementation for the creation, signing, and verification of DataItems and working with bundles [here](LINK)

### 3. Expanding a bundle of DataItems

To read and expand a bundle of DataItems, each DataItem in the `items` should be verified using the verification algorithm. Individual items that fail verification MUST be discarded.

In rare cases, an identical DataItem may exist in more that one transaction. That is, the contents and id of the DataItem are identical but exist in multiple Arweave transactions. This may need be taken into account when expanding bundles of DataItems.

### 4. Writing a bundle of DataItems

To write a bundle of DataItems, each DataItem should constructed and signed to add a signature and id, and placed in a transaction with the format and tags specified in section 1.
